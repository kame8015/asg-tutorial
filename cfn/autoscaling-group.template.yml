AWSTemplateFormatVersion: 2010-09-09
Description: Launch Configuration and AutoScalingGroup Configuration

Parameters:
  NetworkStackName:
    Description: Stack Relation With NetworkConfiguration Name
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[a-zA-z][-a-zA-Z0-9]*$
    Default: asg-tutorial-network-config
  KeyName:
    Description: The EC2 Key Pair to allow SSH access to the instance
    Type: AWS::EC2::KeyPair::KeyName
  InstanceMinSize:
    Description: Instance Min Size
    Type: Number
    Default: 0
  InstanceDesiredCapacity:
    Description: Instance Desired Capacity
    Type: Number
    Default: 1
  InstanceMaxSize:
    Description: Instance Max Size
    Type: Number
    Default: 2

Resources:
  # 1. 起動設定を作る
  LaunchConfiguration:
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      AssociatePublicIpAddress: true
      ImageId: ami-0ee1410f0644c1cac # Amazon Linux AMI 2018.03.0 (HVM), SSD Volume Type
      InstanceMonitoring: false
      InstanceType: t2.micro
      KeyName: !Ref KeyName # EC2とSSH接続するために必要
      LaunchConfigurationName: demo-launch-configuration # 起動設定名
      SecurityGroups:
        - Fn::ImportValue: !Sub ${NetworkStackName}-SecurityGroupID

  # 2. AutoScalingGroupを作成する
  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: demo-autoscaling-group # AutoScalingGroup名
      LaunchConfigurationName: !Ref LaunchConfiguration
      MinSize: !Ref InstanceMinSize
      DesiredCapacity: !Ref InstanceDesiredCapacity
      MaxSize: !Ref InstanceMaxSize
      Tags:
        - Key: Name
          PropagateAtLaunch: true
          Value: asg-tutorial-ec2 # EC2インスタンスの名前
      VPCZoneIdentifier:
        - Fn::ImportValue: !Sub ${NetworkStackName}-SubnetID
      MetricsCollection: # メトリクスを有効化
        - Granularity: 1Minute
          Metrics:
            - GroupInServiceInstances